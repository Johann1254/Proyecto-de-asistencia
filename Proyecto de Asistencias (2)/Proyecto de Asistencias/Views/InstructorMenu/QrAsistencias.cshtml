@{ 
    Layout = null;
    ViewBag.Title = "Generar QR de Asistencias";
    int idUsuario = ViewBag.IdUsuario; // Obtener el ID del instructor desde ViewBag
}

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <link href="~/CSS/CSSvistasInstructor.css" rel="stylesheet" />
    <link href="~/CSS/cssQRAsistencia.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Instructor Jesus Marzal Barboza</h1>
            <h4>Generar Código QR para Asistencias</h4>
        </div>
        <div class="form-container">
            <div class="form-field">
                <label for="date">Fecha</label>
                <input type="date" id="date">
            </div>
            <div class="form-field">
                <label for="ficha">Seleccione el número de la Ficha</label>
                <select id="ficha" class="form-control">
                    @foreach (var item in ViewBag.Fichas)
                    {
        <option value="@item.Value">@item.Text</option>
}
                </select>
            </div>
            <div class="form-field">
                <label for="programa_formacion">Seleccione el programa de formación:</label>
                <select id="programa_formacion" class="form-control">
                    @foreach (var item in ViewBag.Programa_Formacion)
                    {
        <option value="@item.Value">@item.Text</option>
}
                </select>
            </div>
            <div class="form-field">
                <label for="competencias">Seleccione la competencia:</label>
                <select id="competencias" class="form-control">
                    @foreach (var item in ViewBag.Competencia)
                    {
        <option value="@item.Value">@item.Text</option>
}
                </select>
            </div>
            <button class="button" id="generate-qr-btn" onclick="generarQR(@idUsuario)">Generar QR</button>
            <button class="button" onclick="eliminarQR()">Eliminar QR</button>
        </div>
        <br />
        <br />
        <div id="qr-container" class="qr-container" style="display:none;">
            <h4>Códigos QR Generados:</h4>
            <div id="qrs"></div>
            
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            var today = new Date();
            var day = String(today.getDate()).padStart(2, '0');
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var year = today.getFullYear();
            var currentDate = year + '-' + month + '-' + day;

            var dateInput = document.getElementById('date');
            dateInput.setAttribute('min', currentDate);
            dateInput.setAttribute('max', currentDate);
            dateInput.setAttribute('value', currentDate);
        });

        function generarQR(idUsuario) {
            var fecha = document.getElementById('date').value;
            var fichaId = document.getElementById('ficha').value;
            var programa = document.getElementById('programa_formacion').value;
            var competencias = document.getElementById('competencias').value;

            if (fecha === '' || fichaId === '') {
                alert('Por favor, ingrese todos los datos.');
                return;
            }

            // Deshabilitar el botón de generar QR
            $('#generate-qr-btn').prop('disabled', true);

            $.ajax({
                url: '@Url.Action("ObtenerCodigoQR", "InstructorMenu")',
                type: 'GET',
                data: { fecha: fecha, nameprog: programa, namecompe: competencias, fichaId: fichaId, instructorId: idUsuario },
                success: function (data) {
                    $('#qrs').empty();
                    data.forEach(function (qrCode) {
                        var img = $('<img>').attr('src', `data:image/png;base64,${qrCode}`).attr('alt', 'Código QR');
                        $('#qrs').append(img);
                    });
                    $('#qr-container').show();
                },
                error: function () {
                    alert('Error al generar el código QR.');
                },
                complete: function() {
                    // Volver a habilitar el botón de generar QR
                    $('#generate-qr-btn').prop('disabled', false);
                }
            });
        }

        function eliminarQR() {
            $.ajax({
                url: '@Url.Action("EliminarCodigoQR", "InstructorMenu")',
                type: 'POST',
                success: function (data) {
                    if (data.success) {
                        $('#qrs').empty();
                        $('#qr-container').hide();
                        alert('Código QR eliminado con éxito.');
                    } else {
                        alert('Error al eliminar el código QR.');
                    }
                },
                error: function () {
                    alert('Error al eliminar el código QR.');
                }
            });
        }
    </script>
</body>
</html>